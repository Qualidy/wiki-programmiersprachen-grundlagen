# Application Server 2 – Tomcat Configuration & Performance

!!! abstract "Lernziele"
    Nach diesem Kapitel kannst du …

    - **Tomcat-Konfiguration** im Detail verstehen.
    - **Server.xml** und **Context.xml** konfigurieren.
    - **Performance-Tuning** durchführen.
    - **Logging** und Monitoring einrichten.
    - **Sicherheit** und SSL konfigurieren.

---

## Einführung

Eine korrekte **Tomcat-Konfiguration** ist essenziell für:
- **Performance** (Response-Zeit, Throughput)
- **Sicherheit** (Authentifizierung, Autorisierung)
- **Stabilität** (Memory, Threads)
- **Wartbarkeit** (Logging, Monitoring)

**Wichtige Fakten:**
- Tomcat verwendet **XML-Konfigurationsdateien**
- **server.xml** ist die Hauptkonfiguration
- **Context.xml** pro Anwendung
- **web.xml** pro Webanwendung
- **JVM-Parameter** beeinflussen Performance

---

## Server.xml (Hauptkonfiguration)

### Struktur
```xml
<?xml version="1.0" encoding="UTF-8"?>
<Server port="8005" shutdown="SHUTDOWN">
  <!-- Global Naming Resources -->
  <GlobalNamingResources>
    <!-- Datenbank-Connection-Pools, JNDI -->
  </GlobalNamingResources>

  <!-- Service: Engine + Connector -->
  <Service name="Catalina">
    <!-- Connector: HTTP/HTTPS -->
    <Connector port="8080" protocol="HTTP/1.1"
               connectionTimeout="20000"
               redirectPort="8443" />

    <!-- Engine: Verarbeitungs-Engine -->
    <Engine name="Catalina" defaultHost="localhost">
      <!-- Host: Virtueller Host -->
      <Host name="localhost" appBase="webapps"
            unpackWARs="true" autoDeploy="true">
        <!-- Context: Anwendung -->
        <Context path="/meine-app" docBase="meine-app" />
      </Host>
    </Engine>
  </Service>
</Server>
```

### Connector-Konfiguration
```xml
<!-- HTTP Connector -->
<Connector port="8080" protocol="HTTP/1.1"
           connectionTimeout="20000"
           redirectPort="8443"
           maxThreads="200"
           minSpareThreads="25"
           acceptCount="100"
           maxConnections="10000"
           enableLookups="false"
           disableUploadTimeout="true"
           compression="on"
           compressionMinSize="2048"
           compressableMimeType="text/html,text/xml,text/plain,text/css,text/javascript,application/json"
           URIEncoding="UTF-8" />
```

**Wichtige Parameter:**
- **maxThreads**: Maximale Threads (Standard: 200)
- **minSpareThreads**: Minimale Threads im Pool
- **acceptCount**: Anfragen in Warteschlange
- **connectionTimeout**: Timeout in ms
- **enableLookups**: DNS-Lookup (false für Performance)
- **compression**: GZIP-Kompression

### HTTPS Connector
```xml
<Connector port="8443" protocol="org.apache.coyote.http11.Http11NioProtocol"
           maxThreads="150" SSLEnabled="true"
           scheme="https" secure="true"
           keystoreFile="conf/keystore.jks"
           keystorePass="changeit"
           clientAuth="false" sslProtocol="TLS"
           keyAlias="tomcat" />
```

### Engine & Host
```xml
<Engine name="Catalina" defaultHost="localhost">
  <!-- Realm: Benutzerverwaltung -->
  <Realm className="org.apache.catalina.realm.UserDatabaseRealm"
         resourceName="UserDatabase" />

  <Host name="localhost" appBase="webapps"
        unpackWARs="true" autoDeploy="true"
        deployOnStartup="true" undeployOldVersions="true">

    <!-- Access Log -->
    <Valve className="org.apache.catalina.valves.AccessLogValve"
           directory="logs"
           prefix="localhost_access_log."
           suffix=".txt"
           pattern="%h %l %u %t &quot;%r&quot; %s %b" />

    <!-- Error Pages -->
    <Valve className="org.apache.catalina.valves.ErrorReportValve"
           showReport="false" showServerInfo="false" />
  </Host>
</Engine>
```

---

## Context.xml (Anwendungskonfiguration)

### Globale Context-Datei
**Datei: `conf/context.xml`**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<Context>
  <!-- Connection-Pooling -->
  <Resource name="jdbc/myDB"
            auth="Container"
            type="javax.sql.DataSource"
            driverClassName="com.mysql.cj.jdbc.Driver"
            url="jdbc:mysql://localhost:3306/mydb"
            username="user"
            password="password"
            maxTotal="20"
            maxIdle="10"
            maxWaitMillis="10000"
            validationQuery="SELECT 1"
            testOnBorrow="true"
            removeAbandonedOnBorrow="true"
            removeAbandonedTimeout="60" />

  <!-- Session-Management -->
  <Manager pathname="" />
  <Manager className="org.apache.catalina.session.PersistentManager"
           saveOnRestart="false"
           maxActiveSessions="-1"
           minIdleSwap="60"
           maxIdleSwap="300" />

  <!-- Caching -->
  <Resources cachingAllowed="true"
             cacheMaxSize="100000" />
</Context>
```

### Anwendungsspezifischer Context
**Datei: `conf/Catalina/localhost/meine-app.xml`**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<Context docBase="meine-app" reloadable="true">
  <!-- Session-Timeout (Minuten) -->
  <session-config>
    <session-timeout>30</session-timeout>
  </session-config>

  <!-- Security -->
  <security-constraint>
    <web-resource-collection>
      <web-resource-name>Protected</web-resource-name>
      <url-pattern>/admin/*</url-pattern>
    </web-resource-collection>
    <auth-constraint>
      <role-name>admin</role-name>
    </auth-constraint>
  </security-constraint>

  <!-- Login-Config -->
  <login-config auth-method="BASIC" realm-name="Tomcat Manager" />

  <!-- Environment -->
  <Environment name="app.version" value="1.0.0"
               type="java.lang.String" override="false" />
</Context>
```

---

## web.xml (Webanwendungskonfiguration)

### Grundlegende Struktur
```xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="https://jakarta.ee/xml/ns/jakartaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="https://jakarta.ee/xml/ns/jakartaee
                             https://jakarta.ee/xml/ns/jakartaee/web-app_5_0.xsd"
         version="5.0">

  <!-- Display Name -->
  <display-name>Meine Webanwendung</display-name>

  <!-- Welcome Files -->
  <welcome-file-list>
    <welcome-file>index.html</welcome-file>
    <welcome-file>index.jsp</welcome-file>
  </welcome-file-list>

  <!-- Error Pages -->
  <error-page>
    <error-code>404</error-code>
    <location>/error/404.jsp</location>
  </error-page>

  <error-page>
    <error-code>500</error-code>
    <location>/error/500.jsp</location>
  </error-page>

  <error-page>
    <exception-type>java.lang.Exception</exception-type>
    <location>/error/error.jsp</location>
  </error-page>

  <!-- Session-Config -->
  <session-config>
    <session-timeout>30</session-timeout>
    <cookie-config>
      <http-only>true</http-only>
      <secure>true</secure>
    </cookie-config>
  </session-config>

  <!-- Security -->
  <security-constraint>
    <web-resource-collection>
      <web-resource-name>Protected Area</web-resource-name>
      <url-pattern>/admin/*</url-pattern>
      <http-method>GET</http-method>
      <http-method>POST</http-method>
    </web-resource-collection>
    <auth-constraint>
      <role-name>admin</role-name>
      <role-name>manager</role-name>
    </auth-constraint>
    <user-data-constraint>
      <transport-guarantee>CONFIDENTIAL</transport-guarantee>
    </user-data-constraint>
  </security-constraint>

  <!-- Login Config -->
  <login-config auth-method="FORM" realm-name="Tomcat Manager">
    <form-login-config>
      <form-login-page>/login.jsp</form-login-page>
      <form-error-page>/login-error.jsp</form-error-page>
    </form-login-config>
  </login-config>

  <!-- Servlets -->
  <servlet>
    <servlet-name>MyServlet</servlet-name>
    <servlet-class>com.example.MyServlet</servlet-class>
    <init-param>
      <param-name>config</param-name>
      <param-value>/WEB-INF/config.properties</param-value>
    </init-param>
    <load-on-startup>1</load-on-startup>
  </servlet>

  <servlet-mapping>
    <servlet-name>MyServlet</servlet-name>
    <url-pattern>/myservlet</url-pattern>
  </servlet-mapping>

  <!-- Filters -->
  <filter>
    <filter-name>EncodingFilter</filter-name>
    <filter-class>com.example.EncodingFilter</filter-class>
    <init-param>
      <param-name>encoding</param-name>
      <param-value>UTF-8</param-value>
    </init-param>
  </filter>

  <filter-mapping>
    <filter-name>EncodingFilter</filter-name>
    <url-pattern>/*</url-pattern>
  </filter-mapping>

  <!-- Listeners -->
  <listener>
    <listener-class>com.example.MyContextListener</listener-class>
  </listener>

</web-app>
```

---

## JVM-Parameter & Performance

### Setzen der JVM-Parameter
**Windows: `bin/setenv.bat`**
```batch
set JAVA_OPTS=%JAVA_OPTS% -Xms512m -Xmx2048m
set JAVA_OPTS=%JAVA_OPTS% -XX:+UseG1GC
set JAVA_OPTS=%JAVA_OPTS% -XX:+UseStringDeduplication
set JAVA_OPTS=%JAVA_OPTS% -XX:+HeapDumpOnOutOfMemoryError
set JAVA_OPTS=%JAVA_OPTS% -XX:HeapDumpPath=C:\logs\heapdump.hprof
set JAVA_OPTS=%JAVA_OPTS% -Djava.awt.headless=true
```

**Linux/Mac: `bin/setenv.sh`**
```bash
export JAVA_OPTS="$JAVA_OPTS -Xms512m -Xmx2048m"
export JAVA_OPTS="$JAVA_OPTS -XX:+UseG1GC"
export JAVA_OPTS="$JAVA_OPTS -XX:+UseStringDeduplication"
export JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError"
export JAVA_OPTS="$JAVA_OPTS -XX:HeapDumpPath=/var/log/tomcat/heapdump.hprof"
export JAVA_OPTS="$JAVA_OPTS -Djava.awt.headless=true"
```

### Wichtige JVM-Parameter

#### Memory
- **-Xms**: Start-Heap-Größe (z. B. 512m)
- **-Xmx**: Max-Heap-Größe (z. B. 2048m)
- **-XX:MaxMetaspaceSize**: Max Metaspace (z. B. 256m)
- **-XX:ReservedCodeCacheSize**: Code-Cache (z. B. 256m)

#### Garbage Collection
- **-XX:+UseG1GC**: G1 Garbage Collector (empfohlen)
- **-XX:+UseParallelGC**: Parallel GC (Standard)
- **-XX:+UseConcMarkSweepGC**: CMS (veraltet)
- **-XX:MaxGCPauseMillis**: Max GC-Pause (z. B. 200)

#### Performance
- **-Djava.awt.headless=true**: Headless-Modus
- **-Djava.security.egd=file:/dev/./urandom**: Entropy-Quelle
- **-XX:+UseStringDeduplication**: String-Deduplizierung
- **-XX:+UseCompressedOops**: Compressed OOPs (64-bit)

#### Debugging
- **-Xdebug**: Debug-Modus aktivieren
- **-Xrunjdwp:transport=dt_socket,address=8000,server=y,suspend=n**: Remote Debug
- **-XX:+HeapDumpOnOutOfMemoryError**: Heap-Dump bei OOM
- **-XX:+PrintGCDetails**: GC-Details loggen

### Beispiel-Konfiguration für Production
```bash
# Für 4GB RAM Server
JAVA_OPTS="
  -Xms1024m
  -Xmx3072m
  -XX:MaxMetaspaceSize=256m
  -XX:ReservedCodeCacheSize=256m
  -XX:+UseG1GC
  -XX:MaxGCPauseMillis=200
  -XX:+UseStringDeduplication
  -XX:+HeapDumpOnOutOfMemoryError
  -XX:HeapDumpPath=/var/log/tomcat/heapdump.hprof
  -Djava.awt.headless=true
  -Djava.security.egd=file:/dev/./urandom
  -Dfile.encoding=UTF-8
"
```

---

## Logging-Konfiguration

### Log4j2 (Empfohlen)
**Datei: `conf/log4j2.xml`**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<Configuration status="WARN">
  <Appenders>
    <!-- Console Appender -->
    <Console name="Console" target="SYSTEM_OUT">
      <PatternLayout pattern="%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"/>
    </Console>

    <!-- File Appender -->
    <File name="File" fileName="logs/catalina.out">
      <PatternLayout pattern="%d{yyyy-MM-dd HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"/>
    </File>

    <!-- Rolling File Appender -->
    <RollingFile name="RollingFile" fileName="logs/app.log"
                 filePattern="logs/app-%d{yyyy-MM-dd}-%i.log.gz">
      <PatternLayout pattern="%d{yyyy-MM-dd HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"/>
      <Policies>
        <TimeBasedTriggeringPolicy/>
        <SizeBasedTriggeringPolicy size="10 MB"/>
      </Policies>
      <DefaultRolloverStrategy max="10"/>
    </RollingFile>
  </Appenders>

  <Loggers>
    <!-- Root Logger -->
    <Root level="info">
      <AppenderRef ref="Console"/>
      <AppenderRef ref="RollingFile"/>
    </Root>

    <!-- Application Logger -->
    <Logger name="com.meineapp" level="debug" additivity="false">
      <AppenderRef ref="RollingFile"/>
    </Logger>

    <!-- Tomcat Logger -->
    <Logger name="org.apache.catalina" level="info" additivity="false">
      <AppenderRef ref="RollingFile"/>
    </Logger>

    <!-- Database Logger -->
    <Logger name="org.apache.tomcat.jdbc.pool" level="debug" additivity="false">
      <AppenderRef ref="RollingFile"/>
    </Logger>
  </Loggers>
</Configuration>
```

### Tomcat-Logging (Standard)
**Datei: `conf/logging.properties`**
```properties
# Root Logger
handlers = 1catalina.org.apache.juli.FileHandler, 2localhost.org.apache.juli.FileHandler, java.util.logging.ConsoleHandler

# Catalina Logger
1catalina.org.apache.juli.FileHandler.level = FINE
1catalina.org.apache.juli.FileHandler.directory = ${catalina.base}/logs
1catalina.org.apache.juli.FileHandler.prefix = catalina.

# Localhost Logger
2localhost.org.apache.juli.FileHandler.level = FINE
2localhost.org.apache.juli.FileHandler.directory = ${catalina.base}/logs
2localhost.org.apache.juli.FileHandler.prefix = localhost.

# Console Handler
java.util.logging.ConsoleHandler.level = FINE
java.util.logging.ConsoleHandler.formatter = org.apache.juli.OneLineFormatter

# Logger Levels
org.apache.catalina.level = INFO
org.apache.catalina.core.StandardContext.level = INFO
org.apache.catalina.session.level = INFO
```

---

## Monitoring & Management

### JMX (Java Management Extensions)
**Aktivieren in `bin/setenv.sh`:**
```bash
export JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote"
export JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote.port=9000"
export JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote.ssl=false"
export JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote.authenticate=true"
export JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote.password.file=${CATALINA_BASE}/conf/jmxremote.password"
export JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote.access.file=${CATALINA_BASE}/conf/jmxremote.access"
```

**Datei: `conf/jmxremote.access`**
```
monitorRole readonly
adminRole readwrite
```

**Datei: `conf/jmxremote.password`**
```
monitorRole password123
adminRole password456
```

### Manager-Web-App
**Aktivieren in `conf/tomcat-users.xml`:**
```xml
<role rolename="manager-gui"/>
<role rolename="manager-script"/>
<role rolename="manager-jmx"/>
<role rolename="manager-status"/>
<user username="admin" password="admin123" roles="manager-gui,manager-script,manager-jmx,manager-status"/>
```

**Zugriff:** `http://localhost:8080/manager`

### Health-Check Endpoint
**Erstellen in `webapps/manager/WEB-INF/web.xml`:**
```xml
<servlet>
  <servlet-name>HealthCheck</servlet-name>
  <servlet-class>com.example.HealthCheckServlet</servlet-class>
</servlet>

<servlet-mapping>
  <servlet-name>HealthCheck</servlet-name>
  <url-pattern>/health</url-pattern>
</servlet-mapping>
```

---

## Sicherheit

### SSL/TLS Konfiguration
**Datei: `conf/server.xml` (Connector):**
```xml
<Connector port="8443" protocol="org.apache.coyote.http11.Http11NioProtocol"
           maxThreads="150" SSLEnabled="true"
           scheme="https" secure="true"
           keystoreFile="conf/keystore.jks"
           keystorePass="changeit"
           keyAlias="tomcat"
           clientAuth="false" sslProtocol="TLS"
           ciphers="TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
           sslEnabledProtocols="TLSv1.2,TLSv1.3" />
```

### Keystore erstellen
```bash
# Selbstsigniertes Zertifikat
keytool -genkeypair -alias tomcat -keyalg RSA -keysize 2048 \
  -keystore conf/keystore.jks -validity 365 \
  -storepass changeit -keypass changeit \
  -dname "CN=localhost, OU=IT, O=MeineFirma, L=Stadt, ST=State, C=DE"
```

### Security-Constraints
**In `web.xml`:**
```xml
<security-constraint>
  <web-resource-collection>
    <web-resource-name>Protected</web-resource-name>
    <url-pattern>/admin/*</url-pattern>
    <http-method>GET</http-method>
    <http-method>POST</http-method>
  </web-resource-collection>
  <auth-constraint>
    <role-name>admin</role-name>
  </auth-constraint>
  <user-data-constraint>
    <transport-guarantee>CONFIDENTIAL</transport-guarantee>
  </user-data-constraint>
</security-constraint>
```

---

## Performance-Tuning

### Connection-Pooling
**In `conf/context.xml`:**
```xml
<Resource name="jdbc/myDB"
          auth="Container"
          type="javax.sql.DataSource"
          driverClassName="com.mysql.cj.jdbc.Driver"
          url="jdbc:mysql://localhost:3306/mydb?useSSL=false&amp;serverTimezone=UTC"
          username="user"
          password="password"
          maxTotal="50"
          maxIdle="20"
          minIdle="5"
          maxWaitMillis="10000"
          validationQuery="SELECT 1"
          testOnBorrow="true"
          testWhileIdle="true"
          timeBetweenEvictionRunsMillis="30000"
          minEvictableIdleTimeMillis="60000"
          removeAbandonedOnBorrow="true"
          removeAbandonedTimeout="60"
          logAbandoned="true" />
```

### Session-Management
**In `conf/context.xml`:**
```xml
<Manager pathname=""
         maxActiveSessions="1000"
         minIdleSwap="60"
         maxIdleSwap="300"
         saveOnRestart="false" />
```

### Caching
**In `conf/context.xml`:**
```xml
<Resources cachingAllowed="true"
           cacheMaxSize="100000"
           cacheTtl="60000"
           cacheMaxSize="100000" />
```

### GZIP-Kompression
**In `conf/server.xml` (Connector):**
```xml
<Connector port="8080" protocol="HTTP/1.1"
           compression="on"
           compressionMinSize="2048"
           compressableMimeType="text/html,text/xml,text/plain,text/css,text/javascript,application/json,application/xml"
           noCompressionUserAgents="gozilla, traviata"
           compressionMinSize="2048" />
```

---

## Häufige Fehler & Best Practices

### Fehler 1: Port-Konflikte
```
Port 8080 required by Tomcat is already in use
```
**Lösung:**
- Ändere Port in `conf/server.xml`
- Oder beende den Prozess: `netstat -ano | findstr :8080`

### Fehler 2: OutOfMemoryError
```
java.lang.OutOfMemoryError: Java heap space
```
**Lösung:**
- Erhöhe `-Xmx` in `setenv.sh`/`setenv.bat`
- Prüfe Memory-Leaks mit JProfiler oder VisualVM

### Fehler 3: ClassNotFoundException
```
java.lang.ClassNotFoundException: com.example.MyClass
```
**Lösung:**
- Bibliothek in `WEB-INF/lib` oder `lib/` kopieren
- Classpath prüfen

### Fehler 4: Session-Timeout zu kurz
**Lösung:**
- In `web.xml` oder `context.xml` erhöhen
- Session-Management optimieren

### Best Practices
1. **Separate JVM** für Tomcat (nicht auf gleicher Maschine wie DB)
2. **Connection-Pooling** immer verwenden
3. **Session-Replication** für Cluster
4. **Regular-Logging** und Monitoring
5. **Security-Updates** regelmäßig installieren
6. **Backup** von Konfigurationen und Daten
7. **Performance-Tests** vor Production-Deployment

---

## Zusammenfassung & Checkliste

### Wichtige Konzepte
- ✅ **server.xml**: Hauptkonfiguration (Connector, Engine, Host)
- ✅ **context.xml**: Anwendungskonfiguration (Resources, Session)
- ✅ **web.xml**: Webanwendungskonfiguration (Servlets, Security)
- ✅ **JVM-Parameter**: Memory, GC, Performance
- ✅ **Logging**: Konfiguration und Auswertung
- ✅ **Monitoring**: JMX, Manager-App, Health-Checks
- ✅ **Sicherheit**: SSL, Security-Constraints, Authentifizierung

### Checkliste für Setup
- [ ] Port-Konfiguration korrekt
- [ ] JVM-Parameter angepasst
- [ ] Connection-Pooling konfiguriert
- [ ] Logging aktiviert
- [ ] Security konfiguriert (SSL, Auth)
- [ ] Monitoring eingerichtet
- [ ] Backup-Strategie definiert

---

## Nächste Schritte

Nachdem du diese Grundlagen beherrschst:
1. **Tomcat Clustering** - Load Balancing & Session Replication
2. **Docker & Kubernetes** - Containerisierung
3. **Performance-Tuning** - JProfiler, VisualVM
4. **Security Hardening** - OWASP Guidelines

**Empfohlene Ressourcen:**
- [Apache Tomcat Documentation](https://tomcat.apache.org/tomcat-10.1-doc/)
- [Tomcat Performance Tuning](https://www.baeldung.com/tomcat-performance-tuning)
- [Oracle Tomcat Best Practices](https://docs.oracle.com/javaee/6/tutorial/doc/giwpq.html)
