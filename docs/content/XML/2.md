# XML Grundlagen 2 – DTD & XML Schema

!!! abstract "Lernziele"
    Nach diesem Kapitel kannst du …

    - **DTDs** (Document Type Definitions) erstellen und verwenden.
    - **XML Schema (XSD)** für komplexe Strukturen definieren.
    - **Validierung** von XML-Dokumenten durchführen.
    - **Element- und Attribut-Definitionen** schreiben.
    - **Datentypen** in XML Schema verstehen.

---

## Einführung

**Validierung** ist der Prozess, bei dem geprüft wird, ob ein XML-Dokument einer bestimmten Struktur entspricht. DTD und XML Schema sind zwei Standards zur Definition dieser Struktur.

**Wichtige Fakten:**
- **DTD** ist älter (XML 1.0), einfacher, aber weniger mächtig
- **XML Schema (XSD)** ist moderner (XML 1.1), komplexer, aber mächtiger
- Beide ermöglichen **Typ-Validierung** und **Struktur-Prüfung**
- **Namespaces** werden in XSD besser unterstützt

---

## DTD (Document Type Definition)

### Was ist eine DTD?
Eine DTD definiert die **erlaubte Struktur** eines XML-Dokuments:
- Welche Elemente sind erlaubt?
- In welcher Reihenfolge?
- Welche Attribute?
- Welche Datentypen?

### Interne DTD
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE adressbuch [
  <!ELEMENT adressbuch (kontakt+)>
  <!ELEMENT kontakt (name, email, telefon, adresse)>
  <!ELEMENT name (#PCDATA)>
  <!ELEMENT email (#PCDATA)>
  <!ELEMENT telefon (#PCDATA)>
  <!ELEMENT adresse (strasse, stadt, plz)>
  <!ELEMENT strasse (#PCDATA)>
  <!ELEMENT stadt (#PCDATA)>
  <!ELEMENT plz (#PCDATA)>
  <!ATTLIST kontakt id CDATA #REQUIRED>
]>

<adressbuch>
  <kontakt id="1">
    <name>Max Mustermann</name>
    <email>max@example.com</email>
    <telefon>+49 123 456789</telefon>
    <adresse>
      <strasse>Hauptstraße 1</strasse>
      <stadt>Berlin</stadt>
      <plz>10115</plz>
    </adresse>
  </kontakt>
</adressbuch>
```

### Externe DTD
**Datei: `adressbuch.dtd`**
```dtd
<!ELEMENT adressbuch (kontakt+)>
<!ELEMENT kontakt (name, email, telefon, adresse)>
<!ELEMENT name (#PCDATA)>
<!ELEMENT email (#PCDATA)>
<!ELEMENT telefon (#PCDATA)>
<!ELEMENT adresse (strasse, stadt, plz)>
<!ELEMENT strasse (#PCDATA)>
<!ELEMENT stadt (#PCDATA)>
<!ELEMENT plz (#PCDATA)>
<!ATTLIST kontakt id CDATA #REQUIRED>
```

**XML-Datei:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE adressbuch SYSTEM "adressbuch.dtd">

<adressbuch>
  <!-- Inhalt -->
</adressbuch>
```

### DTD-Elemente

#### 1. Element-Definitionen
```dtd
<!-- Leeres Element -->
<!ELEMENT br EMPTY>

<!-- Element mit Inhalt -->
<!ELEMENT paragraph (#PCDATA)>

<!-- Element mit Unterelementen -->
<!ELEMENT artikel (titel, autor, inhalt)>

<!-- Optional (0 oder 1 Mal) -->
<!ELEMENT option (titel?)>

<!-- Wiederholung (0 oder mehr) -->
<!ELEMENT liste (item*)>

<!-- Pflicht (1 oder mehr) -->
<!ELEMENT liste (item+)>

<!-- Oder (eines von) -->
<!ELEMENT status (aktiv | inaktiv | gesperrt)>
```

#### 2. Attribut-Definitionen
```dtd
<!-- Pflicht-Attribut -->
<!ATTLIST kontakt id CDATA #REQUIRED>

<!-- Optional -->
<!ATTLIST kontakt status CDATA #IMPLIED>

<!-- Standardwert -->
<!ATTLIST kontakt aktiv (ja | nein) "ja">

<!-- Fixierter Wert -->
<!ATTLIST kontakt typ CDATA #FIXED "privat">

<!-- Liste von Werten -->
<!ATTLIST kontakt status (neu | aktiv | inaktiv) "neu">
```

#### 3. Datentypen in DTD
- **CDATA**: Zeichenketten (keine Entitäten)
- **ID**: Eindeutiger Identifikator (muss eindeutig sein)
- **IDREF**: Verweis auf eine ID
- **IDREFS**: Mehrere Verweise (durch Leerzeichen getrennt)
- **NMTOKEN**: Name (Buchstaben, Ziffern, Unterstrich)
- **NMTOKENS**: Mehrere NMTOKENs
- **ENTITY**: Entitäts-Referenz
- **ENTITIES**: Mehrere Entitäten
- **NOTATION**: Notation-Referenz

### Beispiel: Komplexe DTD
```dtd
<!ELEMENT buch (titel, autor+, kapitel+)>
<!ELEMENT titel (#PCDATA)>
<!ELEMENT autor (name, email?)>
<!ELEMENT name (#PCDATA)>
<!ELEMENT email (#PCDATA)>
<!ELEMENT kapitel (titel, abschnitt+)>
<!ELEMENT abschnitt (ueberschrift?, text+)>
<!ELEMENT ueberschrift (#PCDATA)>
<!ELEMENT text (#PCDATA)>

<!ATTLIST buch isbn CDATA #REQUIRED
                kategorie (fachbuch | belletristik) #REQUIRED>

<!ATTLIST autor rolle (autor | mitautor | hrsg) "autor">

<!ATTLIST kapitel nummer CDATA #REQUIRED
                  seitenzahl CDATA #IMPLIED>
```

{{ task(file="tasks/03_00_03.yaml") }}

---

## XML Schema (XSD)

### Was ist XML Schema?
**XML Schema** (XSD - XML Schema Definition) ist ein modernerer Standard als DTD:
- **Namespaces** werden vollständig unterstützt
- **Komplexe Datentypen** möglich
- **Vererbung** und **Komposition**
- **Mächtigere Validierung**

### Grundlegende Struktur
```xml
<?xml version="1.0" encoding="UTF-8"?>
<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema">

  <!-- Element-Definition -->
  <xs:element name="adressbuch">
    <xs:complexType>
      <xs:sequence>
        <xs:element name="kontakt" maxOccurs="unbounded">
          <!-- Komplexer Typ -->
        </xs:element>
      </xs:sequence>
    </xs:complexType>
  </xs:element>

</xs:schema>
```

### Einfache Typen (Simple Types)
```xml
<!-- Einfacher Typ mit Einschränkungen -->
<xs:simpleType name="emailType">
  <xs:restriction base="xs:string">
    <xs:pattern value="[^@]+@[^\.]+\..+"/>
  </xs:restriction>
</xs:simpleType>

<!-- Aufzählung -->
<xs:simpleType name="statusType">
  <xs:restriction base="xs:string">
    <xs:enumeration value="neu"/>
    <xs:enumeration value="aktiv"/>
    <xs:enumeration value="inaktiv"/>
  </xs:restriction>
</xs:simpleType>

<!-- Zahl mit Bereich -->
<xs:simpleType name="alterType">
  <xs:restriction base="xs:integer">
    <xs:minInclusive value="0"/>
    <xs:maxInclusive value="120"/>
  </xs:restriction>
</xs:simpleType>
```

### Komplexe Typen (Complex Types)
```xml
<!-- Komplexer Typ mit Attributen -->
<xs:complexType name="kontaktType">
  <xs:sequence>
    <xs:element name="name" type="xs:string"/>
    <xs:element name="email" type="emailType"/>
    <xs:element name="telefon" type="xs:string" minOccurs="0"/>
  </xs:sequence>
  <xs:attribute name="id" type="xs:ID" use="required"/>
  <xs:attribute name="status" type="statusType" default="neu"/>
</xs:complexType>

<!-- Komplexer Typ mit Choice -->
<xs:complexType name="adresseType">
  <xs:choice>
    <xs:element name="strasse" type="xs:string"/>
    <xs:element name="postfach" type="xs:string"/>
  </xs:choice>
  <xs:element name="stadt" type="xs:string"/>
  <xs:element name="plz" type="xs:string"/>
</xs:complexType>
```

### Vollständiges Beispiel
```xml
<?xml version="1.0" encoding="UTF-8"?>
<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema">

  <!-- Einfache Typen -->
  <xs:simpleType name="emailType">
    <xs:restriction base="xs:string">
      <xs:pattern value="[^@]+@[^\.]+\..+"/>
    </xs:restriction>
  </xs:simpleType>

  <xs:simpleType name="statusType">
    <xs:restriction base="xs:string">
      <xs:enumeration value="neu"/>
      <xs:enumeration value="aktiv"/>
      <xs:enumeration value="inaktiv"/>
    </xs:restriction>
  </xs:simpleType>

  <!-- Komplexe Typen -->
  <xs:complexType name="adresseType">
    <xs:sequence>
      <xs:element name="strasse" type="xs:string"/>
      <xs:element name="stadt" type="xs:string"/>
      <xs:element name="plz" type="xs:string"/>
    </xs:sequence>
  </xs:complexType>

  <xs:complexType name="kontaktType">
    <xs:sequence>
      <xs:element name="name" type="xs:string"/>
      <xs:element name="email" type="emailType"/>
      <xs:element name="telefon" type="xs:string" minOccurs="0"/>
      <xs:element name="adresse" type="adresseType"/>
    </xs:sequence>
    <xs:attribute name="id" type="xs:ID" use="required"/>
    <xs:attribute name="status" type="statusType" default="neu"/>
  </xs:complexType>

  <!-- Wurzelelement -->
  <xs:element name="adressbuch">
    <xs:complexType>
      <xs:sequence>
        <xs:element name="kontakt" type="kontaktType" maxOccurs="unbounded"/>
      </xs:sequence>
    </xs:complexType>
  </xs:element>

</xs:schema>
```

### Vererbung (Extension)
```xml
<!-- Basisklasse -->
<xs:complexType name="personType">
  <xs:sequence>
    <xs:element name="name" type="xs:string"/>
  </xs:sequence>
</xs:complexType>

<!-- Abgeleitete Klasse -->
<xs:complexType name="mitarbeiterType">
  <xs:complexContent>
    <xs:extension base="personType">
      <xs:sequence>
        <xs:element name="abteilung" type="xs:string"/>
        <xs:element name="gehalt" type="xs:decimal"/>
      </xs:sequence>
      <xs:attribute name="id" type="xs:ID" use="required"/>
    </xs:extension>
  </xs:complexContent>
</xs:complexType>
```

---

## Validierung

### Validierung mit DTD
```bash
# Mit xmllint (Linux/Mac)
xmllint --valid --noout dokument.xml

# Mit Java
javax.xml.validation.Validator
```

### Validierung mit XML Schema
```bash
# Mit xmllint
xmllint --schema adressbuch.xsd --noout dokument.xml

# Mit Java
javax.xml.validation.Validator
```

### Java-Validierung
```java
import javax.xml.XMLConstants;
import javax.xml.transform.stream.StreamSource;
import javax.xml.validation.*;

public class XMLValidator {
    public static void main(String[] args) throws Exception {
        // Schema erstellen
        SchemaFactory factory =
            SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);
        Schema schema = factory.newSchema(new File("adressbuch.xsd"));

        // Validator erstellen
        Validator validator = schema.newValidator();

        // XML validieren
        try {
            validator.validate(new StreamSource(new File("adressbuch.xml")));
            System.out.println("XML ist gültig!");
        } catch (Exception e) {
            System.out.println("XML ist ungültig: " + e.getMessage());
        }
    }
}
```

---

## Häufige Fehler & Best Practices

### Fehler 1: Fehlende DTD/XSD-Referenz
```xml
<!-- ❌ Falsch (keine Validierung möglich) -->
<?xml version="1.0"?>
<adressbuch>
  <!-- ... -->
</adressbuch>

<!-- ✅ Gut -->
<?xml version="1.0"?>
<!DOCTYPE adressbuch SYSTEM "adressbuch.dtd">
<adressbuch>
  <!-- ... -->
</adressbuch>
```

### Fehler 2: Ungültige Element-Reihenfolge
```xml
<!-- ❌ Falsch (Reihenfolge nicht wie in DTD definiert) -->
<kontakt>
  <email>max@example.com</email>
  <name>Max</name> <!-- Falsche Reihenfolge! -->
</kontakt>

<!-- ✅ Gut -->
<kontakt>
  <name>Max</name>
  <email>max@example.com</email>
</kontakt>
```

### Fehler 3: Fehlende erforderliche Attribute
```xml
<!-- ❌ Falsch (id ist required) -->
<kontakt status="aktiv">
  <!-- ... -->
</kontakt>

<!-- ✅ Gut -->
<kontakt id="1" status="aktiv">
  <!-- ... -->
</kontakt>
```

### Best Practices
1. **Interne DTD** für einfache Dokumente
2. **Externe DTD/XSD** für komplexe Strukturen
3. **Namespaces** in XSD korrekt verwenden
4. **Validierung** während der Entwicklung
5. **Kommentare** in DTD/XSD für Dokumentation
6. **Versionierung** von Schemas

---

## Zusammenfassung & Checkliste

### Wichtige Konzepte
- ✅ **DTD**: Älterer Standard, einfache Validierung
- ✅ **XML Schema (XSD)**: Moderner, mächtigerer Standard
- ✅ **Validierung**: Prüfung der XML-Struktur
- ✅ **Elemente & Attribute**: Definitionen in DTD/XSD
- ✅ **Datentypen**: Einfache und komplexe Typen
- ✅ **Namespaces**: Wichtig für XSD

### Checkliste für DTD/XSD
- [ ] Wurzelelement definiert
- [ ] Alle Elemente definiert
- [ ] Reihenfolge korrekt (sequence/choice)
- [ ] Attribute korrekt definiert
- [ ] Datentypen passend
- [ ] Validierung erfolgreich

---

## Nächste Schritte

Nachdem du diese Grundlagen beherrschst:
1. **XPath** - XML-Daten abfragen
2. **XSLT** - XML transformieren
3. **XQuery** - XML-Datenbanken abfragen
4. **Relax NG** - Alternative zu DTD/XSD

**Empfohlene Ressourcen:**
- [W3Schools DTD Tutorial](https://www.w3schools.com/xml/xml_dtd.asp)
- [W3Schools XSD Tutorial](https://www.w3schools.com/xml/schema_intro.asp)
- [XML.com](https://www.xml.com/)
